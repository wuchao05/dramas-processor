# 飞书日期去重功能使用指南

## 功能概述

飞书日期去重功能解决了在多次执行剪辑任务时重复处理相同日期剧集的问题。该功能可以记录每个日期已经处理过的剧集，在后续运行时自动跳过这些剧集，避免重复工作。

## 使用场景

### 典型场景

- **每日处理任务**: 每天从飞书拉取当天的剧集进行剪辑
- **补充处理**: 某个日期的剧集没有全部处理完，需要继续处理剩余部分
- **重新处理**: 某些剧集需要重新生成素材

### 解决的问题

1. **避免重复剪辑**: 已经剪辑过的 9.12 号剧集不会再次被处理
2. **节省时间**: 自动跳过已处理剧集，专注于新剧集
3. **状态管理**: 清楚地知道哪些日期的哪些剧集已经处理

## 命令参数

### 飞书命令新增参数

```bash
# 基础飞书命令
drama-processor feishu run --date 9.12

# 启用日期去重（跳过已处理剧集）
drama-processor feishu run --date 9.12 --skip-processed

# 强制重新处理（忽略历史记录）
drama-processor feishu run --date 9.12 --force-reprocess

# 同时启用AI和去重功能
drama-processor feishu run --date 9.12 --ai-scene-detection --skip-processed
```

### 参数说明

- `--skip-processed`: 启用日期去重，跳过已经处理过的剧集
- `--force-reprocess`: 强制重新处理所有剧集，忽略历史记录
- 两个参数不能同时使用，`--force-reprocess` 优先级更高

## 使用示例

### 示例 1: 首次处理某日期

```bash
# 第一次处理9.12号的剧集
drama-processor feishu run --date 9.12 --skip-processed

# 输出示例:
# 📋 从飞书获取到 10 部待处理剧目
# 📊 去重结果: 10 部剧集均为新剧集
# ... 正常处理流程 ...
# 💾 已更新剧集处理记录
```

### 示例 2: 再次处理相同日期

```bash
# 第二次运行相同日期
drama-processor feishu run --date 9.12 --skip-processed

# 输出示例:
# 📝 日期去重结果:
#   - 跳过已处理剧集: 8 部
#     ⏭️  剧集A
#     ⏭️  剧集B
#     ...
#   - 待处理剧集: 2 部
# 📋 从飞书获取到 2 部待处理剧目
```

### 示例 3: 强制重新处理

```bash
# 强制重新处理所有剧集（忽略历史）
drama-processor feishu run --date 9.12 --force-reprocess

# 输出示例:
# 🔄 强制重新处理模式已启用，将忽略历史记录
# 📋 从飞书获取到 10 部待处理剧目
```

## 管理命令

### 查看处理记录

```bash
# 列出所有日期的处理记录
drama-processor feishu dedup --action list

# 输出示例:
# ================================================================================
# 📅 日期去重记录列表
# ================================================================================
# 📅 日期: 9.11
#    已处理剧集: 15 部
#    最后更新: 2025-09-11T22:30:45.123456
#    --------------------------------------------------
# 📅 日期: 9.12
#    已处理剧集: 8 部
#    最后更新: 2025-09-12T14:20:30.654321
#    --------------------------------------------------
#
# 📊 总计: 2 个日期有处理记录
```

### 查看特定日期详情

```bash
# 查看9.12号的详细处理记录
drama-processor feishu dedup --action summary --date 9.12

# 输出示例:
# ============================================================
# 📅 日期 9.12 的处理摘要
# ============================================================
# 已处理剧集数量: 8
# 最后更新时间: 2025-09-12T14:20:30.654321
#
# 📋 已处理剧集列表:
#   1. 剧集名称A
#   2. 剧集名称B
#   3. 剧集名称C
#   ...
```

### 清除处理记录

```bash
# 清除9.12号的处理记录
drama-processor feishu dedup --action clear --date 9.12

# 输出示例:
# ⚠️ 将要清除日期 9.12 的处理记录，包含 8 个剧集
# 确认要清除这些记录吗？ [y/N]: y
# ✅ 已成功清除日期 9.12 的处理记录
```

## 存储机制

### 存储位置

- 默认存储在项目根目录的 `history/date_dedup/` 文件夹
- 每个日期对应一个 JSON 文件，如 `09-12.json`

### 文件格式

```json
{
  "date": "9.12",
  "normalized_date": "09-12",
  "last_updated": "2025-09-12T14:20:30.654321",
  "processed_dramas": ["剧集名称A", "剧集名称B", "剧集名称C"],
  "total_count": 3
}
```

### 日期格式处理

- 输入格式: `9.12`, `09.12`, `9-12` 等
- 标准化为: `09-12` 格式存储
- 支持各种常见的日期输入格式

## 配置选项

在 `configs/default.yaml` 中可以配置：

```yaml
# 日期去重设置
date_deduplication:
  enabled: true # 启用日期去重功能
  storage_dir: "history/date_dedup" # 存储目录
  skip_processed_by_default: false # 默认是否跳过已处理剧集
```

## 工作流程

### 1. 启用去重的处理流程

1. 从飞书获取指定日期的剧集列表
2. 加载该日期的历史处理记录
3. 过滤掉已经处理过的剧集
4. 处理剩余的未处理剧集
5. 将新处理的剧集记录到历史文件

### 2. 去重判断逻辑

- 基于剧集名称的完全匹配
- 区分不同日期的处理记录
- 支持跨会话的持久化记录

## 注意事项

### 1. 数据一致性

- 处理记录基于剧集名称，请确保飞书中剧集名称的一致性
- 如果飞书中剧集名称发生变化，可能需要手动清理记录

### 2. 存储空间

- 记录文件会持续累积，建议定期清理不需要的历史记录
- 每个日期的记录文件通常很小（几 KB），不会占用太多空间

### 3. 并发处理

- 多个进程同时处理相同日期时可能出现竞争条件
- 建议避免同时运行多个相同日期的处理任务

### 4. 错误恢复

- 如果处理过程中断，已完成的剧集会被记录
- 重新运行时会自动跳过已记录的剧集

## 故障排除

### 1. 记录文件损坏

```bash
# 删除损坏的记录文件，重新开始
drama-processor feishu dedup --action clear --date 9.12
```

### 2. 误跳过剧集

```bash
# 使用强制重新处理
drama-processor feishu run --date 9.12 --force-reprocess
```

### 3. 记录不准确

```bash
# 查看详细记录，手动清理
drama-processor feishu dedup --action summary --date 9.12
drama-processor feishu dedup --action clear --date 9.12
```

## 最佳实践

### 1. 日常使用

- 建议默认启用 `--skip-processed` 参数
- 定期使用 `dedup list` 命令查看处理状态

### 2. 维护管理

- 每月清理一次过期的日期记录
- 在重大更新前备份重要的处理记录

### 3. 错误处理

- 处理失败时不会更新记录，可以安全重试
- 部分成功的情况下，已完成部分会被记录

## 版本兼容性

该功能为新增功能，与现有的所有功能完全兼容：

- 可以与 AI 场景检测功能同时使用
- 与现有的剪辑点去重功能独立工作
- 不影响传统的批量处理命令

## 总结

飞书日期去重功能提供了一个高效的方式来管理重复的剪辑任务，特别适合：

- 需要多次处理相同日期剧集的场景
- 长期的内容生产工作流
- 需要精确控制处理状态的团队协作

通过合理使用该功能，可以显著提高工作效率，减少重复劳动。


